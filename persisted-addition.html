<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add and Summarize Numbers</title>
</head>
<body>
    <div class="container">
        <h1>Add a Number and Summarize Them</h1>
        <p>Enter a number below. The calculator will correctly summarize the numbers.</p>
        <p><strong>Bonus improvement:</strong> Prevents adding invalid inputs.</p>
        
        <input type="text" id="numberInput" placeholder="Enter an integer">
        <button id="addButton">Add Number</button>
        
        <div class="list">
            <div id="numberList"></div>
            =
            <h3><span id="totalSum">0</span></h3>
        </div>
    </div>

    <script>
        const numberInput = document.getElementById('numberInput');
        const addButton = document.getElementById('addButton');
        const numberList = document.getElementById('numberList');
        const totalSum = document.getElementById('totalSum');

        const testResults = [];

        document.addEventListener('DOMContentLoaded', function(){
            //run unit tests and persist the Test results
            unitTests();

            testResults.forEach((testResult, index) => {
                const key = `testResult_${index}`;
                localStorage.setItem(key, JSON.stringify(testResult));
                if(!testResult.passed){
                    alert(`Test failed! ${testResult.error}`);
                    return;
                }
            });
              
        });
    
        let enteredNumbers = [];

        addButton.addEventListener('click', function () {
            const number = numberInput.value.trim();

            // Check if input is a valid integer (no decimals, no empty input)
            if (!/^-?\d+$/.test(number)) { 
                alert('Please enter a valid integer.');
                return;
            }

            const numValue = parseInt(number, 10);
            enteredNumbers.push(numValue);

            const summarize = handleCalculation(enteredNumbers);

            numberList.textContent = summarize.numbers.join(' + ');
            totalSum.textContent = summarize.sum;

            numberInput.value = '';
            numberInput.focus();
        });

        function handleCalculation(enteredNumbers) {             
            // Save the enteredNumbers to localStorage             
            localStorage.setItem('calculatorNumbers', JSON.stringify(enteredNumbers));

            // Read from localStorage            
            let persistedNumbers = []; 

            const stored = localStorage.getItem('calculatorNumbers');  

            if (stored) {                
                persistedNumbers = JSON.parse(stored);             
            } else {                  
                persistedNumbers = enteredNumbers;             
            } 

            // Addition             
            const sum = persistedNumbers.reduce((total, num) => total + num, 0);    

            return {                 
                numbers: persistedNumbers,                 
                sum: sum             
            };         
        }

        function unitTests() {
            
            // Test single number
            test('Single number test', () => {
                const result = handleCalculation([5]);
                
                if (result.sum !== 5) {
                    throw new Error(`Expected sum to be 5, but got ${result.sum}`);
                }
                
                if (result.numbers.length !== 1) {
                    throw new Error(`Expected 1 number, but got ${result.numbers.length}`);
                }
                
                if (result.numbers[0] !== 5) {
                    throw new Error(`Expected first number to be 5, but got ${result.numbers[0]}`);
                }
            });
            
            // Test multiple numbers
            test('Multiple numbers test', () => {
                const result = handleCalculation([10, 20, 30]);
                
                if (result.sum !== 60) {
                    throw new Error(`Expected sum to be 60, but got ${result.sum}`);
                }
                
                if (result.numbers.length !== 3) {
                    throw new Error(`Expected 3 numbers, but got ${result.numbers.length}`);
                }
            });
            
            // Test negative numbers
            test('Negative numbers test', () => {
                const result = handleCalculation([-5, 10, -3]);
                
                if (result.sum !== 2) {
                    throw new Error(`Expected sum to be 2, but got ${result.sum}`);
                }
            });
            
            // Test zero values
            test('Zero values test', () => {
                const result = handleCalculation([0, 5, 0]);
                
                if (result.sum !== 5) {
                    throw new Error(`Expected sum to be 5, but got ${result.sum}`);
                }
                
                if (result.numbers.length !== 3) {
                    throw new Error(`Expected 3 numbers, but got ${result.numbers.length}`);
                }
            });
            
            // Test empty array
            test('Empty array test', () => {
                const result = handleCalculation([]);
                
                if (result.sum !== 0) {
                    throw new Error(`Expected sum to be 0, but got ${result.sum}`);
                }
                
                if (result.numbers.length !== 0) {
                    throw new Error(`Expected 0 numbers, but got ${result.numbers.length}`);
                }
            });
            
            // Test localStorage persistence
            test('localStorage persistence test', () => {
                // First call
                const result1 = handleCalculation([100, 200]);
                
                // Check localStorage directly
                const stored = localStorage.getItem('calculatorNumbers');
                const parsedStored = JSON.parse(stored);
                
                if (parsedStored.length !== 2) {
                    throw new Error(`Expected 2 numbers in localStorage, but got ${parsedStored.length}`);
                }
                
                if (parsedStored[0] !== 100 || parsedStored[1] !== 200) {
                    throw new Error(`Expected [100, 200] in localStorage, but got [${parsedStored}]`);
                }
                
                // Second call should read from localStorage
                const result2 = handleCalculation([100, 200, 300]);
                
                if (result2.sum !== 600) {
                    throw new Error(`Expected sum to be 600, but got ${result2.sum}`);
                }
            });
            
        }

        // Test helper function
        function test(testName, testFunction) {
            try {
                // Clear localStorage before each test
                localStorage.removeItem('calculatorNumbers');
                
                // Run the test
                testFunction();
                
                // If no error thrown, test passed
                testResults.push({
                    name: testName,
                    passed: true,
                    error: null
                });
            } catch (error) {
                // If error thrown, test failed
                testResults.push({
                    name: testName,
                    passed: false,
                    error: error.message
                });
            }
        }
        
    </script>
</body>
</html>